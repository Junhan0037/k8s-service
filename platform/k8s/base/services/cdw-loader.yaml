# CDW 적재 배치/스트리밍 워커를 정의합니다.
---
apiVersion: v1
kind: Service
metadata:
  name: cdw-loader
  labels:
    app.kubernetes.io/component: service
    app.kubernetes.io/name: cdw-loader
spec:
  ports:
    - name: http
      port: 8080  # 게이트웨이가 일관된 8080 포트로 접근하도록 유지한다.
      targetPort: http
  selector:
    app.kubernetes.io/name: cdw-loader
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cdw-loader
  labels:
    app.kubernetes.io/component: service
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: cdw-loader
  template:
    metadata:
      labels:
        app.kubernetes.io/name: cdw-loader
        app.kubernetes.io/component: service
    spec:
      containers:
        - name: cdw-loader
          image: researchex/cdw-loader:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8106  # Spring Boot server.port(8106)과 동일하게 노출한다.
          envFrom:
            - configMapRef:
                name: researchex-common-config
            - secretRef:
                name: researchex-postgres-secret
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: http
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: http
            initialDelaySeconds: 30
            periodSeconds: 15
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "500m"
              memory: "1Gi"

-- ResearchEx 로컬 개발 환경용 초기 스키마 및 시드 데이터 구성 스크립트
-- 각 서비스 도메인에 필요한 최소한의 테이블 구조를 정의하고 학습용 더미 데이터를 적재한다.

-- 공용 스키마/함수 ------------------------------------------------------------
CREATE SCHEMA IF NOT EXISTS researchex_core;
CREATE SCHEMA IF NOT EXISTS researchex_registry;
CREATE SCHEMA IF NOT EXISTS researchex_user;
CREATE SCHEMA IF NOT EXISTS researchex_mr;
CREATE SCHEMA IF NOT EXISTS researchex_deid;
CREATE SCHEMA IF NOT EXISTS researchex_cdw;
CREATE SCHEMA IF NOT EXISTS researchex_research;

-- UUID 생성을 위해 pgcrypto 확장을 활성화한다. (엔터프라이즈 환경에서는 별도 권한 통제 필요)
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- updated_at 컬럼을 자동으로 갱신하기 위한 공용 트리거 함수
CREATE OR REPLACE FUNCTION researchex_core.touch_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 레지스트리 서비스 -----------------------------------------------------------
-- 연구 과제를 표현하는 마스터 테이블
CREATE TABLE IF NOT EXISTS researchex_registry.studies (
  study_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  public_id UUID NOT NULL DEFAULT gen_random_uuid(),
  study_code VARCHAR(64) NOT NULL,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  disease_area VARCHAR(120) NOT NULL,
  study_phase VARCHAR(32),
  status VARCHAR(32) NOT NULL DEFAULT 'DRAFT',
  sponsor VARCHAR(150),
  principal_investigator VARCHAR(120),
  planned_participant_count INTEGER,
  start_date DATE,
  end_date DATE,
  tags JSONB DEFAULT '[]'::jsonb,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT uq_studies_code UNIQUE (study_code),
  CONSTRAINT uq_studies_public UNIQUE (public_id),
  CONSTRAINT chk_studies_status CHECK (status IN ('DRAFT', 'ENROLLING', 'ACTIVE', 'SUSPENDED', 'CLOSED')),
  CONSTRAINT chk_studies_phase CHECK (study_phase IS NULL OR study_phase IN ('I', 'II', 'III', 'IV', 'NA')),
  CONSTRAINT chk_planned_participant_count CHECK (planned_participant_count IS NULL OR planned_participant_count >= 0),
  CONSTRAINT chk_dates_valid CHECK (end_date IS NULL OR start_date IS NULL OR end_date >= start_date)
);

-- 연구 참여 기관 매핑 테이블
CREATE TABLE IF NOT EXISTS researchex_registry.study_sites (
  site_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  study_id BIGINT NOT NULL REFERENCES researchex_registry.studies(study_id) ON DELETE CASCADE,
  site_code VARCHAR(32) NOT NULL,
  site_name VARCHAR(160) NOT NULL,
  country VARCHAR(56),
  city VARCHAR(80),
  contact_name VARCHAR(120),
  contact_email VARCHAR(160),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT uq_study_site UNIQUE (study_id, site_code)
);

DROP TRIGGER IF EXISTS trg_studies_touch ON researchex_registry.studies;
CREATE TRIGGER trg_studies_touch
BEFORE UPDATE ON researchex_registry.studies
FOR EACH ROW EXECUTE FUNCTION researchex_core.touch_updated_at();

DROP TRIGGER IF EXISTS trg_study_sites_touch ON researchex_registry.study_sites;
CREATE TRIGGER trg_study_sites_touch
BEFORE UPDATE ON researchex_registry.study_sites
FOR EACH ROW EXECUTE FUNCTION researchex_core.touch_updated_at();

-- 사용자/권한 서비스 ----------------------------------------------------------
-- 사용자 계정 기본 정보
CREATE TABLE IF NOT EXISTS researchex_user.user_accounts (
  user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(80) NOT NULL,
  email VARCHAR(160) NOT NULL,
  display_name VARCHAR(150) NOT NULL,
  password_hash VARCHAR(120) NOT NULL,
  status VARCHAR(32) NOT NULL DEFAULT 'ACTIVE',
  timezone VARCHAR(64) DEFAULT 'Asia/Seoul',
  last_login_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT uq_user_username UNIQUE (username),
  CONSTRAINT uq_user_email UNIQUE (email),
  CONSTRAINT chk_user_status CHECK (status IN ('ACTIVE', 'LOCKED', 'SUSPENDED'))
);

-- 시스템 권한 정의
CREATE TABLE IF NOT EXISTS researchex_user.user_roles (
  role_key VARCHAR(60) PRIMARY KEY,
  display_name VARCHAR(120) NOT NULL,
  description VARCHAR(255)
);

-- 사용자-권한 매핑
CREATE TABLE IF NOT EXISTS researchex_user.user_role_mappings (
  user_id UUID NOT NULL REFERENCES researchex_user.user_accounts(user_id) ON DELETE CASCADE,
  role_key VARCHAR(60) NOT NULL REFERENCES researchex_user.user_roles(role_key) ON DELETE CASCADE,
  granted_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  granted_by UUID,
  PRIMARY KEY (user_id, role_key)
);

DROP TRIGGER IF EXISTS trg_users_touch ON researchex_user.user_accounts;
CREATE TRIGGER trg_users_touch
BEFORE UPDATE ON researchex_user.user_accounts
FOR EACH ROW EXECUTE FUNCTION researchex_core.touch_updated_at();

-- MR 뷰어 서비스 --------------------------------------------------------------
-- 환자 기본 프로필
CREATE TABLE IF NOT EXISTS researchex_mr.patients (
  patient_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mrn VARCHAR(40) NOT NULL,
  full_name VARCHAR(120) NOT NULL,
  gender VARCHAR(16) NOT NULL DEFAULT 'UNKNOWN',
  birth_date DATE,
  deceased BOOLEAN NOT NULL DEFAULT FALSE,
  preferred_language VARCHAR(40) DEFAULT 'ko',
  blood_type VARCHAR(8),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_patients_mrn ON researchex_mr.patients(mrn);
CREATE INDEX IF NOT EXISTS idx_patients_name ON researchex_mr.patients USING gin (to_tsvector('simple', full_name));

-- 진료 내역(Encounter) 테이블
CREATE TABLE IF NOT EXISTS researchex_mr.encounters (
  encounter_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES researchex_mr.patients(patient_id) ON DELETE CASCADE,
  encounter_type VARCHAR(32) NOT NULL,
  encounter_at TIMESTAMPTZ NOT NULL,
  facility VARCHAR(160),
  attending_physician VARCHAR(120),
  department VARCHAR(120),
  discharge_disposition VARCHAR(120),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_encounter_patient ON researchex_mr.encounters(patient_id);

-- 임상 문서 기록
CREATE TABLE IF NOT EXISTS researchex_mr.clinical_documents (
  document_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  encounter_id UUID REFERENCES researchex_mr.encounters(encounter_id) ON DELETE SET NULL,
  patient_id UUID NOT NULL REFERENCES researchex_mr.patients(patient_id) ON DELETE CASCADE,
  document_type VARCHAR(64) NOT NULL,
  title VARCHAR(160),
  author VARCHAR(120),
  authored_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  summary TEXT,
  body TEXT,
  sensitive BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_documents_patient ON researchex_mr.clinical_documents(patient_id);

-- 주요 바이탈 및 검사 Observation
CREATE TABLE IF NOT EXISTS researchex_mr.observations (
  observation_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  patient_id UUID NOT NULL REFERENCES researchex_mr.patients(patient_id) ON DELETE CASCADE,
  code VARCHAR(64) NOT NULL,
  code_system VARCHAR(64) NOT NULL DEFAULT 'LOINC',
  value_numeric NUMERIC(12,4),
  value_text VARCHAR(255),
  unit VARCHAR(32),
  reference_range VARCHAR(64),
  effective_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_observations_patient ON researchex_mr.observations(patient_id);

-- 가명화(De-identification) 서비스 -------------------------------------------
CREATE TABLE IF NOT EXISTS researchex_deid.deid_jobs (
  job_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_system VARCHAR(80) NOT NULL,
  payload_locator VARCHAR(180) NOT NULL,
  status VARCHAR(32) NOT NULL DEFAULT 'QUEUED',
  requested_by UUID REFERENCES researchex_user.user_accounts(user_id),
  requested_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  total_records INTEGER,
  processed_records INTEGER,
  failure_reason TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT chk_deid_status CHECK (status IN ('QUEUED', 'PROCESSING', 'COMPLETED', 'FAILED'))
);

CREATE INDEX IF NOT EXISTS idx_deid_status ON researchex_deid.deid_jobs(status);

DROP TRIGGER IF EXISTS trg_deid_jobs_touch ON researchex_deid.deid_jobs;
CREATE TRIGGER trg_deid_jobs_touch
BEFORE UPDATE ON researchex_deid.deid_jobs
FOR EACH ROW EXECUTE FUNCTION researchex_core.touch_updated_at();

-- CDW Loader 서비스 -----------------------------------------------------------
CREATE TABLE IF NOT EXISTS researchex_cdw.ingestion_jobs (
  job_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_key VARCHAR(120) NOT NULL,
  source_system VARCHAR(80) NOT NULL,
  status VARCHAR(32) NOT NULL DEFAULT 'PENDING',
  batch_window_start TIMESTAMPTZ,
  batch_window_end TIMESTAMPTZ,
  total_records INTEGER,
  success_records INTEGER,
  failed_records INTEGER,
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT uq_ingestion_job_key UNIQUE (job_key),
  CONSTRAINT chk_ingestion_status CHECK (status IN ('PENDING', 'RUNNING', 'COMPLETED', 'FAILED'))
);

CREATE TABLE IF NOT EXISTS researchex_cdw.ingestion_events (
  event_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  job_id UUID NOT NULL REFERENCES researchex_cdw.ingestion_jobs(job_id) ON DELETE CASCADE,
  event_type VARCHAR(64) NOT NULL,
  detail JSONB NOT NULL,
  occurred_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_ingestion_status ON researchex_cdw.ingestion_jobs(status);

DROP TRIGGER IF EXISTS trg_ingestion_jobs_touch ON researchex_cdw.ingestion_jobs;
CREATE TRIGGER trg_ingestion_jobs_touch
BEFORE UPDATE ON researchex_cdw.ingestion_jobs
FOR EACH ROW EXECUTE FUNCTION researchex_core.touch_updated_at();

-- Research 서비스 -------------------------------------------------------------
CREATE TABLE IF NOT EXISTS researchex_research.search_queries (
  query_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  query_hash VARCHAR(64) NOT NULL,
  request_payload JSONB NOT NULL,
  status VARCHAR(32) NOT NULL DEFAULT 'PENDING',
  submitted_by UUID REFERENCES researchex_user.user_accounts(user_id),
  submitted_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  result_reference VARCHAR(120),
  failure_reason TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  CONSTRAINT uq_search_query_hash UNIQUE (query_hash),
  CONSTRAINT chk_search_status CHECK (status IN ('PENDING', 'DISPATCHED', 'SUCCEEDED', 'FAILED'))
);

CREATE INDEX IF NOT EXISTS idx_search_status ON researchex_research.search_queries(status);

CREATE TABLE IF NOT EXISTS researchex_research.search_results (
  result_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  query_id UUID NOT NULL REFERENCES researchex_research.search_queries(query_id) ON DELETE CASCADE,
  result_payload JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

DROP TRIGGER IF EXISTS trg_search_queries_touch ON researchex_research.search_queries;
CREATE TRIGGER trg_search_queries_touch
BEFORE UPDATE ON researchex_research.search_queries
FOR EACH ROW EXECUTE FUNCTION researchex_core.touch_updated_at();

-- 공통 감사 로그 --------------------------------------------------------------
CREATE TABLE IF NOT EXISTS researchex_core.audit_events (
  event_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  event_type VARCHAR(80) NOT NULL,
  entity_type VARCHAR(80),
  entity_id VARCHAR(80),
  actor VARCHAR(120),
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 시드 데이터 -----------------------------------------------------------------
-- 역할 정의
INSERT INTO researchex_user.user_roles(role_key, display_name, description)
VALUES
  ('SYSTEM_ADMIN', '시스템 관리자', '플랫폼 전역 설정과 사용자 관리를 담당한다.'),
  ('DATA_SCIENTIST', '데이터 사이언티스트', '연구 질의 작성과 데이터 분석을 수행한다.'),
  ('DATA_MANAGER', '데이터 매니저', 'CDW 적재와 품질 검증을 담당한다.'),
  ('PI', '연구 책임자', '연구 책임자로서 승인 및 연구 진행을 관리한다.')
ON CONFLICT (role_key) DO NOTHING;

-- 사용자 계정
INSERT INTO researchex_user.user_accounts(
  user_id, username, email, display_name, password_hash, status, timezone, last_login_at)
VALUES
  ('11111111-1111-1111-1111-111111111111', 'admin', 'admin@researchex.local', '시스템 관리자', '$2a$10$2b2o5Nf1XMz9FSjgvDuwjuqSftZBXD3u.Ww9XG0NwVHP2hKNi9p2q', 'ACTIVE', 'Asia/Seoul', NOW()),
  ('22222222-2222-2222-2222-222222222222', 'dmanager', 'dmanager@researchex.local', '데이터 매니저', '$2a$10$1aMGr8om8.Zjy/GF0q.5duG7R1JDvaol0cgEmwAlnPnHo5VIf3F5y', 'ACTIVE', 'Asia/Seoul', NULL),
  ('33333333-3333-3333-3333-333333333333', 'scientist', 'scientist@researchex.local', '데이터 사이언티스트', '$2a$10$7K3s7gKHZ.S3Z1urOSdzz.PgVEzxQnmyKDXBRAI5C3.GPG9ZP0uXm', 'ACTIVE', 'Asia/Seoul', NULL),
  ('44444444-4444-4444-4444-444444444444', 'pi-kim', 'pi.kim@researchex.local', '김연구', '$2a$10$VuXnO2EtAfKpXEf2MHxTneM/eRkfqia5EHCNPiAocd0dt1Xiyg0fe', 'ACTIVE', 'Asia/Seoul', NULL)
ON CONFLICT (user_id) DO NOTHING;

-- 권한 매핑
INSERT INTO researchex_user.user_role_mappings(user_id, role_key, granted_by)
VALUES
  ('11111111-1111-1111-1111-111111111111', 'SYSTEM_ADMIN', '11111111-1111-1111-1111-111111111111'),
  ('22222222-2222-2222-2222-222222222222', 'DATA_MANAGER', '11111111-1111-1111-1111-111111111111'),
  ('33333333-3333-3333-3333-333333333333', 'DATA_SCIENTIST', '11111111-1111-1111-1111-111111111111'),
  ('44444444-4444-4444-4444-444444444444', 'PI', '11111111-1111-1111-1111-111111111111')
ON CONFLICT (user_id, role_key) DO NOTHING;

-- 연구 과제 기본 데이터
INSERT INTO researchex_registry.studies(
  study_id, public_id, study_code, title, description, disease_area, study_phase, status,
  sponsor, principal_investigator, planned_participant_count, start_date, end_date, tags)
VALUES
  (1001, 'f8ccf659-4345-4f4b-87a4-6e7f3858102c', 'REX-AML-24', '급성 골수성 백혈병 예후 예측 연구',
   'AML 환자의 조기 재발 위험을 예측하기 위한 다변량 모델 개발', 'Hematology', 'II', 'ENROLLING',
   'Researchex Hospital', '김연구', 120, DATE '2024-03-01', DATE '2025-06-30', '["aml","predictive-model"]'::jsonb),
  (1002, '6d0ed54a-336e-4b7a-9684-5a6bfc99d5ae', 'REX-BC-13', '유방암 표적치료 반응성 분석',
   'HR+ 유방암 환자의 약물 반응성을 분석하여 개인맞춤 치료를 지원', 'Oncology', 'III', 'ACTIVE',
   'Researchex Oncology Center', '박임상', 200, DATE '2023-07-01', NULL, '["oncology","targeted-therapy"]'::jsonb),
  (1003, '2f082d8f-5d4e-4b13-a9b5-0d5a08bbdca9', 'REX-CARD-07', '심혈관 질환 위험도 조기 경보',
   '웨어러블 데이터를 활용한 심혈관 이벤트 위험도 조기 경보 모델 구축', 'Cardiology', 'I', 'DRAFT',
   'Researchex Digital Health Lab', '이혁신', 80, DATE '2024-09-01', NULL, '["cardiology","wearable"]'::jsonb)
ON CONFLICT (study_id) DO NOTHING;

INSERT INTO researchex_registry.study_sites(
  study_id, site_code, site_name, country, city, contact_name, contact_email)
VALUES
  (1001, 'SEOUL-GEN', 'Researchex 서울병원 혈액내과', 'KOR', 'Seoul', '정윤호', 'yoonho.jeong@researchex.local'),
  (1002, 'BUSAN-ONC', '부산 암센터', 'KOR', 'Busan', '이소정', 'sojung.lee@researchex.local'),
  (1002, 'DAEJEON-ONC', '대전 임상시험센터', 'KOR', 'Daejeon', '김태호', 'taeho.kim@researchex.local')
ON CONFLICT (study_id, site_code) DO NOTHING;

-- 환자 더미 데이터
INSERT INTO researchex_mr.patients(
  patient_id, mrn, full_name, gender, birth_date, deceased, preferred_language, blood_type)
VALUES
  ('aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'MRN-0001', '한지민', 'FEMALE', DATE '1985-11-02', FALSE, 'ko', 'A+'),
  ('bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', 'MRN-0002', '최준호', 'MALE', DATE '1978-04-18', FALSE, 'ko', 'B+')
ON CONFLICT (patient_id) DO NOTHING;

INSERT INTO researchex_mr.encounters(
  encounter_id, patient_id, encounter_type, encounter_at, facility, attending_physician, department, discharge_disposition)
VALUES
  ('11111111-aaaa-4bbb-8ccc-111111111111', 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', 'INPATIENT', TIMESTAMPTZ '2024-02-15 09:30:00+09', 'Researchex 서울병원', '김민수', '혈액내과', 'HOME'),
  ('22222222-bbbb-4ccc-8ddd-222222222222', 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', 'OUTPATIENT', TIMESTAMPTZ '2024-03-05 14:00:00+09', 'Researchex 심장센터', '이수진', '순환기내과', 'HOME')
ON CONFLICT (encounter_id) DO NOTHING;

INSERT INTO researchex_mr.clinical_documents(
  document_id, encounter_id, patient_id, document_type, title, author, authored_at, summary, body, sensitive)
VALUES
  ('doc-aaaa-bbbb-cccc-ddddeeee0001', '11111111-aaaa-4bbb-8ccc-111111111111', 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa',
   'discharge_summary', '퇴원 요약 - AML 유도요법 1차', '김민수', TIMESTAMPTZ '2024-02-20 15:30:00+09',
   'AML 유도요법 1차 치료 후 안정적으로 퇴원함', '치료 경과: ...\n추적 검사 계획: ...', TRUE),
  ('doc-ffff-gggg-hhhh-iiiijjjj0002', '22222222-bbbb-4ccc-8ddd-222222222222', 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb',
   'clinic_note', '외래 진료 요약 - 심혈관 스크리닝', '이수진', TIMESTAMPTZ '2024-03-05 14:30:00+09',
   '심혈관 스크리닝 결과 위험도 중간 수준', '검사 결과: ...\n생활습관 개선 권고: ...', FALSE)
ON CONFLICT (document_id) DO NOTHING;

INSERT INTO researchex_mr.observations(
  observation_id, patient_id, code, code_system, value_numeric, unit, reference_range, effective_at)
VALUES
  ('obs-aaaa-bbbb-cccc-ddddeeee0001', 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', '718-7', 'LOINC', 9.8, 'g/dL', '12-16', TIMESTAMPTZ '2024-02-18 08:00:00+09'),
  ('obs-ffff-gggg-hhhh-iiiijjjj0002', 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', '8480-6', 'LOINC', 180, 'mg/dL', '<=200', TIMESTAMPTZ '2024-03-05 10:15:00+09')
ON CONFLICT (observation_id) DO NOTHING;

-- De-id 잡 기본 데이터
INSERT INTO researchex_deid.deid_jobs(
  job_id, source_system, payload_locator, status, requested_by, requested_at, started_at, completed_at, total_records, processed_records)
VALUES
  ('55555555-aaaa-4bbb-8ccc-555555555555', 'CDW', 's3://researchex/raw/aml/2024-02-20.parquet', 'COMPLETED',
   '22222222-2222-2222-2222-222222222222', NOW() - INTERVAL '1 day', NOW() - INTERVAL '23 hours', NOW() - INTERVAL '22 hours', 12000, 12000),
  ('66666666-bbbb-4ccc-8ddd-666666666666', 'FHIR', 'https://internal-api/research/requests/8734', 'PROCESSING',
   '33333333-3333-3333-3333-333333333333', NOW() - INTERVAL '2 hours', NOW() - INTERVAL '90 minutes', NULL, 5800, 3200)
ON CONFLICT (job_id) DO NOTHING;

-- CDW 적재 작업 샘플
INSERT INTO researchex_cdw.ingestion_jobs(
  job_id, job_key, source_system, status, batch_window_start, batch_window_end,
  total_records, success_records, failed_records, started_at, completed_at)
VALUES
  ('77777777-aaaa-4bbb-8ccc-777777777777', 'aml-cdw-batch-20240220', 'EHR-ODS', 'COMPLETED',
   NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days' + INTERVAL '4 hours',
   15000, 14980, 20, NOW() - INTERVAL '3 days' + INTERVAL '30 minutes', NOW() - INTERVAL '3 days' + INTERVAL '5 hours'),
  ('88888888-bbbb-4ccc-8ddd-888888888888', 'wearable-sync-20240305', 'Wearable-IoT', 'RUNNING',
   NOW() - INTERVAL '12 hours', NOW(), 4500, 1200, 8, NOW() - INTERVAL '11 hours', NULL)
ON CONFLICT (job_id) DO NOTHING;

INSERT INTO researchex_cdw.ingestion_events(
  event_id, job_id, event_type, detail, occurred_at)
VALUES
  (9001, '77777777-aaaa-4bbb-8ccc-777777777777', 'VALIDATION_COMPLETED', '{"warnings":2,"failures":0}'::jsonb, NOW() - INTERVAL '2 days 21 hours'),
  (9002, '77777777-aaaa-4bbb-8ccc-777777777777', 'LOAD_COMPLETED', '{"target":"researchex_mr.patients"}'::jsonb, NOW() - INTERVAL '2 days 20 hours'),
  (9003, '88888888-bbbb-4ccc-8ddd-888888888888', 'LOAD_PROGRESS', '{"processed":3200}'::jsonb, NOW() - INTERVAL '6 hours')
ON CONFLICT (event_id) DO NOTHING;

-- Research 서비스 검색 질의 샘플
INSERT INTO researchex_research.search_queries(
  query_id, query_hash, request_payload, status, submitted_by, submitted_at, completed_at, result_reference)
VALUES
  ('99999999-aaaa-4bbb-8ccc-999999999999', 'd734b9d996b9bc0ee703f530f552c4a3d375fa1af33e87d5d3ed0fdd3c7e9e73',
   '{"filters":{"diseaseArea":"Hematology","age":{"min":18,"max":75}},"metrics":["participantCount","responseRate"]}'::jsonb,
   'SUCCEEDED', '33333333-3333-3333-3333-333333333333', NOW() - INTERVAL '6 hours', NOW() - INTERVAL '5 hours 50 minutes', 'research-studies/study-aml-20240220'),
  ('aaaaaaa1-bbbb-4ccc-8ddd-aaaaaaaaaaa1', 'c625b3e48c9ad1ef68b850a93cfc9bb8bef9c3f2fa73c1c2dab0ddf5fb092e67',
   '{"filters":{"diseaseArea":"Cardiology","risk":"high"},"metrics":["enrollmentTrend"]}'::jsonb,
   'DISPATCHED', '33333333-3333-3333-3333-333333333333', NOW() - INTERVAL '30 minutes', NULL, NULL)
ON CONFLICT (query_id) DO NOTHING;

INSERT INTO researchex_research.search_results(
  result_id, query_id, result_payload)
VALUES
  ('result-aml-20240220', '99999999-aaaa-4bbb-8ccc-999999999999',
   '{"studyCode":"REX-AML-24","participantCount":98,"responseRate":0.67,"lastUpdated":"2024-02-18T06:30:00Z"}'::jsonb)
ON CONFLICT (result_id) DO NOTHING;

-- 감사 이벤트 샘플
INSERT INTO researchex_core.audit_events(event_id, event_type, entity_type, entity_id, actor, metadata, created_at)
VALUES
  (5001, 'USER_LOGIN', 'USER', 'admin', 'admin', '{"ip":"127.0.0.1"}'::jsonb, NOW() - INTERVAL '1 hour'),
  (5002, 'STUDY_UPDATED', 'STUDY', 'REX-BC-13', 'pi-kim', '{"field":"status","oldValue":"ENROLLING","newValue":"ACTIVE"}'::jsonb, NOW() - INTERVAL '2 days')
ON CONFLICT (event_id) DO NOTHING;

-- 수동으로 삽입한 ID 값이 시퀀스보다 큰 경우 시퀀스를 재동기화한다.
SELECT setval(
  pg_get_serial_sequence('researchex_registry.studies', 'study_id'),
  (SELECT COALESCE(MAX(study_id), 0) FROM researchex_registry.studies),
  TRUE);
SELECT setval(
  pg_get_serial_sequence('researchex_cdw.ingestion_events', 'event_id'),
  (SELECT COALESCE(MAX(event_id), 0) FROM researchex_cdw.ingestion_events),
  TRUE);
SELECT setval(
  pg_get_serial_sequence('researchex_core.audit_events', 'event_id'),
  (SELECT COALESCE(MAX(event_id), 0) FROM researchex_core.audit_events),
  TRUE);
